@inject PosisiService PosisiService
@inject GolonganService GolonganService
@inject DivisiService DivisiService
@inject DepartemenService DepartemenService
@inject LokasiService LokasiService

<div class="row">
    <div class="col-12">
        <div class="fw-bold">
            Informasi Man Power Planning
        </div>
        <div class="border-title"></div>
    </div>
    <div class="col-12 mt-3">
        @if (isPosisiLoaded)
        {
            <SelectComponent label="Nama Posisi" name="posisi" isBold listItems="listItemsPosisi"
                 placeholder="Pilih Nama Posisi..." ValueChanged="HandleSelectChange" />
        }
        else
        {
            <p>Loading...</p>
        }
    </div>
    <div class="col-6">
        @if (isGolonganLoaded)
        {
            <SelectComponent label="Golongan" name="golongan" isBold listItems="listItemsGolongan"
                 placeholder="Pilih Golongan..." ValueChanged="HandleSelectChange" />
        }
        else
        {
            <p>Loading...</p>
        }
    </div>
    <div class="col-6">
        <Input label="Target Pemenuhan" name="targetdate" OnInput="HandleInput" bold placeholder="Pilih Bulan dan Tahun"
             type="date" />
     </div>
     <div class="col-6">
         @if (isDivisiLoaded)
        {
            <SelectComponent label="Divisi Tujuan" name="divisi" isBold listItems="listItemsDivisi"
                 placeholder="Pilih Divisi..." ValueChanged="HandleSelectChange" />
        }
        else
        {
            <p>Loading...</p>
        }
    </div>
    <div class="col-6">
        @if (isDepartemenLoaded)
        {
            <SelectComponent label="Departemen Tujuan" isBold listItems="listItemsDepartemen"
                 placeholder="Pilih Nama Dept..." name="departemen" ValueChanged="HandleSelectChange" />
        }
        else
        {
            <p>Loading...</p>
        }
    </div>
    <div class="col-12">
        @if (isLokasiLoaded)
        {
            <SelectComponent label="Lokasi Penempatan" name="lokasi" isBold listItems="listItemsLokasi"
                 placeholder="Pilih Lokasi..." ValueChanged="HandleSelectChange" />
        }
        else
        {
            <p>Loading...</p>
        }
    </div>
    <div class="col-6">
        <Input label="Jumlah MP Saat ini" type="number" name="jumlahmp" OnInput="HandleInput" bold
             placeholder="Orang" />
     </div>
     <div class="col-6">
         <Input label="Jumlah Permintaan" type="number" name="jumlahpermintaan" OnInput="HandleInput" bold
             placeholder="Orang" />
     </div>
     <div class="col-12">
         <div class="form-group">
             <label class="form-label fw-bold">Alasan Pengajuan</label>
             <textarea class="form-control"></textarea>
         </div>
     </div>
     @if (AppliationState.MppChildForm != null && AppliationState.MppChildForm.TargetPemenuhan != null)
    {
        <div>@(AppliationState.MppChildForm.TargetPemenuhan)</div>
    }
    <div class="d-flex justify-content-end mt-3">
        <Button Label="Selanjutnya" btnClass="btn-outline-info" type="button" onClick="onSwitch" />
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<MouseEventArgs> onSwitch { get; set; }
    [CascadingParameter]
    public AppState AppliationState { get; set; }

    private MppChildForm mppChildForm = new MppChildForm();

    private async Task HandleSelectChange(SelectChangedEventArgs args)
    {
        string selectedName = args.Name;
        string selectedValue = args.Value;


        if (selectedName == "posisi")
        {
            mppChildForm.PosisiId = new Guid(selectedValue);
        }
        else if (selectedName == "golongan")
        {
            mppChildForm.GolonganId = new Guid(selectedValue);
        }
        else if (selectedName == "divisi")
        {
            mppChildForm.DevisiTujuanId = new Guid(selectedValue);
        }
        else if (selectedName == "departemen")
        {
            mppChildForm.DepartemenId = new Guid(selectedValue);
        }
        AppliationState.MppChildForm = mppChildForm;
    }

    private async Task HandleInput(SelectChangedEventArgs args)
    {
        string inputName = args.Name;
        string inputValue = args.Value;

        if (inputName == "targetdate")
        {
            mppChildForm.TargetPemenuhan = DateTime.Parse(inputValue);
        }
        else if (inputName == "jumlahmp")
        {
            mppChildForm.JumlahMp = int.Parse(inputValue);
        }
        else if (inputName == "jumlahpermintaan")
        {
            mppChildForm.JumlahPermintaan = int.Parse(inputValue);
        }
        AppliationState.MppChildForm = mppChildForm;
    }

    private SieveModel mySieveModel = new SieveModel
        {
            Page = 1,
            PageSize = 5,
        };

    /// Posisi
    private List<Posisi> posisiList;
    private List<dynamic> listItemsPosisi;
    private bool isPosisiLoaded = false;

    /// Golongan
    private List<Golongan> GolonganList;
    private List<dynamic> listItemsGolongan;
    private bool isGolonganLoaded = false;

    /// Divisi
    private List<Divisi> DivisiList;
    private List<dynamic> listItemsDivisi;
    private bool isDivisiLoaded = false;

    /// Departemen
    private List<Departemen> DepartemenList;
    private List<dynamic> listItemsDepartemen;
    private bool isDepartemenLoaded = false;

    /// Lokasi
    private List<Lokasi> LokasiList;
    private List<dynamic> listItemsLokasi;
    private bool isLokasiLoaded = false;

    protected async override Task OnInitializedAsync()
    {
        await LoadPosisiAsync();
        await LoadGolonganAsync();
        await LoadDivisiAsync();
        await LoadDepartemenAsync();
        await LoadLokasiAsync();
    }

    private async Task LoadPosisiAsync()
    {
        await PosisiService.LoadPosisi(mySieveModel);

        posisiList = PosisiService.Posisies.Items;

        listItemsPosisi = posisiList
        .Select(x => (dynamic)new { Id = x.Id, Value = x.Name })
        .ToList();

        isPosisiLoaded = true;

        StateHasChanged();
    }
    private async Task LoadGolonganAsync()
    {
        await GolonganService.LoadGolongan(mySieveModel);

        GolonganList = GolonganService.Golongans.Items;

        listItemsGolongan = GolonganList
        .Select(x => (dynamic)new { Id = x.Id, Value = x.Name })
        .ToList();

        isGolonganLoaded = true;
        StateHasChanged();
    }
    private async Task LoadDivisiAsync()
    {
        await DivisiService.LoadDivisi(mySieveModel);

        DivisiList = DivisiService.Divisies.Items;

        listItemsDivisi = DivisiList
        .Select(x => (dynamic)new { Id = x.Id, Value = x.Name })
        .ToList();

        isDivisiLoaded = true;
        StateHasChanged();
    }

    private async Task LoadDepartemenAsync()
    {
        await DepartemenService.LoadDepartemen(mySieveModel);

        DepartemenList = DepartemenService.Departemens.Items;

        listItemsDepartemen = DepartemenList
        .Select(x => (dynamic)new { Id = x.Id, Value = x.Name })
        .ToList();

        isDepartemenLoaded = true;
        StateHasChanged();
    }
    private async Task LoadLokasiAsync()
    {
        await LokasiService.LoadLokasi(mySieveModel);

        LokasiList = LokasiService.Lokasies.Items;

        listItemsLokasi = LokasiList
        .Select(x => (dynamic)new { Id = x.Id, Value = x.Name })
        .ToList();

        isLokasiLoaded = true;
        StateHasChanged();
    }

}
